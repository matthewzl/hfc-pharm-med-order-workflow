<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HAVEN Free Clinic Pharmacy Medication Ordering Pathway</title>
  <style>
    :root { --bg:#f9fafb; --panel:#ffffff; --panel-2:#f3f4f6; --ink:#111827; --muted:#4b5563; --accent:#2563eb; --accent-2:#3b82f6; --border:#d1d5db; --danger:#dc2626; --ok:#16a34a; }
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:920px;margin:28px auto 64px;padding:0 16px}
    header{display:flex;flex-direction:column;align-items:start;gap:8px;margin-bottom:18px}
    .title{font-weight:800;font-size:clamp(20px,3vw,30px);line-height:1.2}
    .subtitle{color:var(--muted);font-size:14px}
    .subtitle a{color:var(--accent);text-decoration:none}
    .subtitle a:hover{text-decoration:underline}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 4px 12px rgba(0,0,0,.05)}
    .q h2{margin:4px 0 4px;font-size:clamp(18px,2.2vw,22px)}
    .meta{color:var(--muted);font-size:13px}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));margin-top:12px}
    button.choice{ text-align:left;background:var(--panel-2);color:var(--ink);border:1px solid var(--border);border-radius:14px;padding:14px;cursor:pointer;transition:transform .08s ease,border-color .2s ease}
    button.choice:hover{ transform:translateY(-1px);border-color:var(--accent)}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center}
    .btn{border:1px solid var(--border);background:var(--panel-2);color:var(--ink);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;border:none}
    .btn.ghost{background:transparent}
    .result{display:grid;gap:10px;margin-top:4px;background:var(--panel-2);border:1px solid var(--border);border-radius:14px;padding:14px}
    .result h3{margin:2px 0 6px;font-size:18px}
    .result ul{margin:0 0 0 20px;padding:0}
    .footer{margin-top:16px;color:var(--muted);font-size:12px}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#e5e7eb;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:start}
    .pathbar{margin:12px 0 0 0;padding:12px;border:1px solid var(--border);border-radius:12px;background:#f3f4f6;font-size:13px;color:var(--muted)}
    .pathbar h4{margin:0 0 6px;font-size:13px;font-weight:600;color:var(--ink)}
    .pathbar .kv{grid-template-columns:28px 1fr}
    .diag{margin:12px 0 0 0;padding:10px;border:1px solid var(--danger);border-radius:12px;background:#fee2e2;color:#991b1b;display:none}
    .diag.ok{border-color:#15803d;background:#dcfce7;color:#14532d}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">HAVEN Free Clinic Pharmacy Medication Ordering Pathway</div>
      <div class="subtitle">Medication ordering pathway to ensure patients can access their medications. <a href="https://www.canva.com/design/DAG0McVOOyg/OVehitJV2CuM3l1PFdwmEg/edit" target="_blank">See full flowchart here</a></div>
    </header>

    <div class="card">
      <div id="app"></div>
      <div class="row" id="navControls" style="margin-top:12px">
        <div class="row" style="gap:8px">
          <button class="btn ghost" id="backBtn">← Back</button>
          <button class="btn" id="restartBtn">Restart</button>
        </div>
      </div>
      <div class="pathbar" id="pathbar">
        <h4>Choice History</h4>
        <div class="meta">Your choice history will show up here...</div>
      </div>
      <div class="diag" id="diag"></div>
    </div>

    <div class="footer">Internal helper for clinic workflow. Please use clinical judgment.</div>
  </div>

  <script>
    // =========================
    // FLOW: Fully defined graph (light theme build)
    // =========================
    const FLOW = {
      start: 'afford',
      nodes: {
        // 1) Affordability gate (first card)
        afford: {
          kind: 'question',
          title: 'Can the patient afford these medications?',
          meta: 'Please discuss cost sharing, consider alternatives that may be less expensive, and remind patient that coupons (e.g., GoodRx, ScriptCycle) are available.',
          choices: [
            { key: 'yes', label: 'Yes — can afford', next: 'act_local' },
            { key: 'no',  label: 'No — cannot afford', next: 'expensive' }
          ]
        },

        // If can afford → local pharmacy (terminal in this slice)
        act_local: {
          kind: 'result',
          title: "Action: Order to patient's preferred local pharmacy",
          items: [
            'Please document this in the <a href=\"https://yaleedu.sharepoint.com/:x:/r/sites/HAVENFreeClinic/_layouts/15/Doc.aspx?sourcedoc=%7B22E51A75-FF5C-49F0-812F-F0E1F873281B%7D&file=HAVEN%20FC%20Pharmacy%20Tracker.xlsx&wdLOR=c4B58A93F-0A75-1C4D-A1C3-30D47C6E990A&action=default&mobileredirect=true\" target="_blank" rel="noopener noreferrer">Pharmacy Tracker</a>. Pharmacy will text coupons (e.g., GoodRx) to patient if available.'
          ]
        },

        // 2) Expensive meds gate
        expensive: {
          kind: 'question',
          title: 'Are any medications expensive?',
          meta: 'Examples: SGLT2i, GLP-1s, DOACs, Epi-Pens, some inhalers',
          choices: [
            { key: 'yes', label: 'Yes — expensive meds present', next: 'bexa_combo' },
            { key: 'no',  label: 'No — none are unusually expensive', next: 'delivery' }
          ]
        },

        // 3) Combined SGLT2i → Brenzavvy gate (direct to Director if not)
        bexa_combo: {
          kind: 'question',
          title: 'Is the expensive med an SGLT2 inhibitor? If so, is it or can it be bexagliflozin (Brenzavvy)?',
          meta: 'If NO, that implies an unaddressed expensive med → escalate to Pharmacy Director.',
          choices: [
            { key: 'yes', label: 'Yes — it is SGLT2i and can be Brenzavvy', next: 'act_brenzavvy' },
            { key: 'no',  label: 'No — not SGLT2i / not Brenzavvy', next: 'msg_dir_expensive' }
          ]
        },

        // Brenzavvy action, then continue to check remaining expensive meds
        act_brenzavvy: {
          kind: 'result',
          title: 'Action: Order Brenzavvy to Marley Drug',
          items: [
            'Order 30-day bexagliflozin to Marley Drug; please document in <a href=\"https://yaleedu.sharepoint.com/:x:/r/sites/HAVENFreeClinic/_layouts/15/Doc.aspx?sourcedoc=%7B22E51A75-FF5C-49F0-812F-F0E1F873281B%7D&file=HAVEN%20FC%20Pharmacy%20Tracker.xlsx&wdLOR=c4B58A93F-0A75-1C4D-A1C3-30D47C6E990A&action=default&mobileredirect=true\" target="_blank" rel="noopener noreferrer">Pharmacy Tracker</a>.',
            'Shows in EPIC as: <b>MARLEY DRUG - WINSTON SALEM, NC - 5008 PETERS CREEK PKWY</b>.',
            'Please note, this med will be <b>DELIVERED</b>; please ensure patient has a secure address.',
            'Verify active refills vs new orders before placing.'
          ],
          actions: [ { label: 'Continue — I have more meds to order', next: 'exp_left' } ]
        },

        // 4) Are there other expensive meds not yet addressed?
        exp_left: {
          kind: 'question',
          title: 'Are there other expensive meds not yet addressed?',
          meta: 'If YES, escalate to Pharmacy Director before proceeding.',
          choices: [
            { key: 'yes', label: 'Yes — escalate to Pharmacy Director', next: 'msg_dir_expensive' },
            { key: 'no',  label: 'No — continue', next: 'delivery' }
          ]
        },

        // Escalation result — terminal
        msg_dir_expensive: {
          kind: 'result',
          title: 'Action: Contact Pharmacy Director',
          items: [
            'Please contact Pharmacy Director to discuss ordering expensive medications.'
          ]
        },

        // 5) Delivery question
        delivery: {
          kind: 'question',
          title: 'Does the patient need delivery?',
          meta: '<b>Delivery is limited.</b> Consider only if necessary.',
          choices: [
            { key: 'yes', label: 'Yes — delivery required', next: 'act_hw' },
            { key: 'no',  label: 'No — pickup feasible', next: 'nh_can' }
          ]
        },

        // Mail-order action — terminal in this slice
        act_hw: {
          kind: 'result',
          title: 'Action: Order to HealthWarehouse (mail-order)',
          items: [
            'Order to HealthWarehouse; document in <a href=\"https://yaleedu.sharepoint.com/:x:/r/sites/HAVENFreeClinic/_layouts/15/Doc.aspx?sourcedoc=%7B22E51A75-FF5C-49F0-812F-F0E1F873281B%7D&file=HAVEN%20FC%20Pharmacy%20Tracker.xlsx&wdLOR=c4B58A93F-0A75-1C4D-A1C3-30D47C6E990A&action=default&mobileredirect=true\" target="_blank" rel="noopener noreferrer">Pharmacy Tracker</a>.',
            'Shows in EPIC as: <b>Healthwarehouse.com - Florence, KY - 7107 Industrial Road</b>.',
            'Verify active refills vs new orders.',
            'Standard delivery takes <b>1-2 weeks</b>.'
          ]
        },

        // 6) NO Delivery → North Haven / DoH branch
        nh_can: {
          kind: 'question',
          title: 'Can the patient go to Dispensary of Hope (DoH)?',
          meta: 'This is <b>highly preferred</b>, as patients can receive medications there for free without needing to use HAVEN\'s budget.<br>The DoH address is: <b>Medical Building, 6 Devine St First Floor, North Haven, CT 06473.</b>',
          choices: [
            { key: 'yes', label: 'Yes — can go to DoH', next: 'doh_all' },
            { key: 'no',  label: 'No — cannot go to DoH', next: 'local_chain' }
          ]
        },

        // DoH formulary check
        doh_all: {
          kind: 'question',
          title: 'Are ALL required meds available on the DoH formulary?',
          meta: 'Look up each med on the <a href=\"https://yaleedu.sharepoint.com/:x:/r/sites/HAVENFreeClinic/_layouts/15/Doc.aspx?sourcedoc=%7B2F6AC501-0F24-473C-BA99-7387E850F08E%7D&file=Dispensary%20of%20Hope%20Formulary%20July%201%202025.xlsx&wdOrigin=TEAMS-MAGLEV.p2p_ns.rwc&action=default&mobileredirect=true\" target="_blank" rel="noopener noreferrer">Dispensary of Hope (DoH) formulary</a>. to verify.',
          choices: [
            { key: 'yes', label: 'Yes — all meds are on DoH', next: 'doh_paperwork_all' },
            { key: 'no',  label: 'No — not all meds are on DoH', next: 'local_chain' }
          ]
        },

        // Paperwork checks before DoH orders
        doh_paperwork_all: {
          kind: 'question',
          title: 'Has the Dispensary of Hope (DoH) paperwork been completed?',
          meta: 'Completed paper work must be within <b>12 months</b>.',
          choices: [
            { key: 'yes', label: 'Yes — paperwork is completed', next: 'act_doh' },
            { key: 'no',  label: 'No / Unclear', next: 'msg_dir_paperwork' }
          ]
        },

        // Some on DoH + willingness to commute to DoH + a community pharmacy
        doh_some_commute: {
          kind: 'question',
          title: 'Are <i>SOME</i> meds on DoH, and is the patient willing to go to DoH + one of the following pharmacies:',
          meta: '<b>ShopRite (preferred)</b>: Orange, East Haven, and Hamden locations only.<br><b>Stop & Shop</b>: West Haven, East Haven, and New Haven locations only.',
          choices: [
            { key: 'yes', label: 'Yes — patient can do DoH + another pharmacy', next: 'doh_paperwork_some' },
            { key: 'no',  label: 'No — cannot split across sites', next: 'msg_dir_route' }
          ]
        },

        doh_paperwork_some: {
          kind: 'question',
          title: 'Has the Dispensary of Hope (DoH) paperwork been completed?',
          meta: 'Completed paper work must be within <b>12 months</b>.',
          choices: [
            { key: 'yes', label: 'Yes — paperwork is completed', next: 'act_doh_plus_pref' },
            { key: 'no',  label: 'No / Unclear', next: 'msg_dir_paperwork' }
          ]
        },

        // Terminal action: order to DoH
        act_doh: {
          kind: 'result',
          title: 'Action: Order to Dispensary of Hope (DoH)',
          items: [
            'Order to Dispensary of Hope (DoH); document in <a href=\"https://yaleedu.sharepoint.com/:x:/r/sites/HAVENFreeClinic/_layouts/15/Doc.aspx?sourcedoc=%7B22E51A75-FF5C-49F0-812F-F0E1F873281B%7D&file=HAVEN%20FC%20Pharmacy%20Tracker.xlsx&wdLOR=c4B58A93F-0A75-1C4D-A1C3-30D47C6E990A&action=default&mobileredirect=true\" target="_blank" rel="noopener noreferrer">Pharmacy Tracker</a>.',
            'Shows in EPIC as: “<b>YNHH Pharmacy North Haven Medical Center</b>”.',
            'Verify active refills vs new orders.'
          ]
        },

        // Terminal action: split order
        act_doh_plus_pref: {
          kind: 'result',
          title: 'Action: Order to DoH AND to selected ShopRite/Stop & Shop',
          items: [
            'Order DoH-formulary meds to the Dispensary of Hope (DoH) clinic. Order remaining meds to ShopRite/Stop & Shop.',
            `<div>
              <strong>EPIC locations for ordering:</strong>
              <ul style="margin:6px 0 0 18px;padding:0;">
                <li><strong>DoH</strong>
                  <ul style="margin:4px 0 0 18px;padding:0;">
                    <li>YNHH Pharmacy North Haven Medical Center</li>
                  </ul>
                </li>
                <li><strong>ShopRite</strong>
                  <ul style="margin:4px 0 0 18px;padding:0;">
                    <li>SHOPRITE OF ORANGE # 325 - Orange, CT - 259 Bull Hill Lane</li>
                    <li>SHOPRITE OF HAMDEN # 324 - Hamden, CT - 2100 Dixwell Ave</li>
                    <li>SHOPRITE OF EAST HAVEN #326 - East Haven, CT - 745 Foxon Road</li>
                  </ul>
                </li>
                <li><strong>Stop &amp; Shop</strong>
                  <ul style="margin:4px 0 0 18px;padding:0;">
                    <li>Stop &amp; Shop Pharmacy # 648 - New Haven, CT - 112 Amity Road Amity Plaza</li>
                    <li>Stop &amp; Shop Pharmacy # 696 - West Haven, CT - 460 Elm Street</li>
                    <li>Stop &amp; Shop Pharmacy # 692 - East Haven, CT - 370 Hemingway Avenue</li>
                  </ul>
                </li>
              </ul>
            </div>`,
            'Document orders in <a href="https://yaleedu.sharepoint.com/:x:/r/sites/HAVENFreeClinic/_layouts/15/Doc.aspx?sourcedoc=%7B22E51A75-FF5C-49F0-812F-F0E1F873281B%7D&file=HAVEN%20FC%20Pharmacy%20Tracker.xlsx&wdLOR=c4B58A93F-0A75-1C4D-A1C3-30D47C6E990A&action=default&mobileredirect=true" target="_blank" rel="noopener noreferrer">Pharmacy Tracker</a>.',
            'Verify active refills vs new orders.'
          ]
        },

        // If cannot go to North Haven → check community pharmacies directly
        local_chain: {
          kind: 'question',
          title: 'Do any of these work: ShopRite (preferred) or Stop & Shop?',
          meta: '<b>ShopRite</b>: Orange, East Haven, and Hamden locations only.<br><b>Stop & Shop</b>: West Haven, East Haven, and New Haven locations only.',
          choices: [
            { key: 'yes', label: 'Yes — one of these works', next: 'act_local_chain' },
            { key: 'no',  label: 'No — none work', next: 'delivery_after_local' }
          ]
        },

        // Follow-up: delivery after local-chain unavailability
        delivery_after_local: {
          kind: 'question',
          title: 'Can the patient receive a delivery?',
          meta: 'If yes, proceed with HealthWarehouse (mail-order). If no, escalate to Pharmacy Director.',
          choices: [
            { key: 'yes', label: 'Yes — delivery is possible', next: 'act_hw' },
            { key: 'no',  label: 'No — delivery not possible', next: 'msg_dir_route' }
          ]
        },

        // Terminal action: order to selected local chain
        act_local_chain: {
          kind: 'result',
          title: 'Action: Order to selected ShopRite/Stop & Shop',
          items: [
            'Order to the chosen ShopRite or Stop & Shop.',
            `<div>
              <strong>EPIC locations for ordering:</strong>
              <ul style="margin:6px 0 0 18px;padding:0;">
                <li><strong>ShopRite</strong>
                  <ul style="margin:4px 0 0 18px;padding:0;">
                    <li>SHOPRITE OF ORANGE # 325 - Orange, CT - 259 Bull Hill Lane</li>
                    <li>SHOPRITE OF HAMDEN # 324 - Hamden, CT - 2100 Dixwell Ave</li>
                    <li>SHOPRITE OF EAST HAVEN #326 - East Haven, CT - 745 Foxon Road</li>
                  </ul>
                </li>
                <li><strong>Stop &amp; Shop</strong>
                  <ul style="margin:4px 0 0 18px;padding:0;">
                    <li>Stop &amp; Shop Pharmacy # 648 - New Haven, CT - 112 Amity Road Amity Plaza</li>
                    <li>Stop &amp; Shop Pharmacy # 696 - West Haven, CT - 460 Elm Street</li>
                    <li>Stop &amp; Shop Pharmacy # 692 - East Haven, CT - 370 Hemingway Avenue</li>
                  </ul>
                </li>
              </ul>
            </div>`,
            'Document orders in <a href="https://yaleedu.sharepoint.com/:x:/r/sites/HAVENFreeClinic/_layouts/15/Doc.aspx?sourcedoc=%7B22E51A75-FF5C-49F0-812F-F0E1F873281B%7D&file=HAVEN%20FC%20Pharmacy%20Tracker.xlsx&wdLOR=c4B58A93F-0A75-1C4D-A1C3-30D47C6E990A&action=default&mobileredirect=true" target="_blank" rel="noopener noreferrer">Pharmacy Tracker</a>.'
          ]
        },

        // Escalation (routing/availability)
        msg_dir_route: {
          kind: 'result',
          title: 'Action: Contact Pharmacy Director',
          items: [
            'Contact Pharmacy Director to discuss available site options.',
          ]
        },

        // Escalation (paperwork)
        msg_dir_paperwork: {
          kind: 'result',
          title: 'Action: Contact Pharmacy Director',
          items: [
            'Confirm DoH eligibility, enrollment, and required paperwork before proceeding.'
          ]
        },

        // Placeholder for future sections
        next_part: {
          kind: 'result',
          title: 'Next section (to be built)',
          items: [
            'Proceed to the next decision block.'
          ]
        }
      }
    };

    // ==================================
    // Engine (supports actions & next)
    // ==================================
    const State = { history: [], answers: {}, current: FLOW.start };

    function render(id){
      const node = FLOW.nodes[id];
      const app = document.getElementById('app');
      if(!node){ app.innerHTML = `<div class="result"><h3>Unknown node: ${id}</h3></div>`; return; }

      if(node.kind==='question'){
        app.innerHTML = `
          <section class="q">
            <h2>${node.title}</h2>
            <div class="meta">${node.meta||''}</div>
            <div class="grid">
              ${node.choices.map(c=>`<button class="choice" data-key="${c.key}" data-next="${c.next}">${c.label}</button>`).join('')}
            </div>
          </section>
        `;
        app.querySelectorAll('button.choice').forEach(btn=>btn.addEventListener('click', onChoose));
      } else {
        const actionButtons = Array.isArray(node.actions) && node.actions.length
          ? node.actions.map((a,i)=>`<button class="btn" data-act="${i}">${a.label}</button>`).join(' ')
          : (node.next ? `<button class="btn primary" id="contBtn">Continue</button>` : '');

        app.innerHTML = `
          <section class="result">
            <h3>${node.title}</h3>
            <ul>${(node.items||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
            ${actionButtons}
          </section>
        `;

        if (Array.isArray(node.actions) && node.actions.length) {
          app.querySelectorAll('button[data-act]').forEach(btn => {
            btn.addEventListener('click', () => {
              const idx = Number(btn.getAttribute('data-act'));
              const action = node.actions[idx];
              if (!action) return;
              State.history.push(State.current); // track result screen visit
              State.current = action.next;
              render(State.current);
            });
          });
        } else if (node.next) {
          const cont = document.getElementById('contBtn');
          if (cont) cont.addEventListener('click', ()=> {
            State.history.push(State.current); // track result screen visit
            State.current = node.next;
            render(State.current);
          });
        }
      }

      // Hide nav controls on the very first card
      const nav = document.getElementById('navControls');
      if (nav) nav.style.display = (id==='afford') ? 'none' : 'flex';

      const backBtn = document.getElementById('backBtn');
      if (backBtn) backBtn.disabled = State.history.length===0;

      updatePathbar();
    }

    function renderPath(){
      return State.history.map((id,i)=>{
        const q = FLOW.nodes[id]; const a = State.answers[id];
        const ans = a ? `Answer: ${a}` : '';
        return `<div class="kv"><div><span class="kbd">${i+1}</span></div><div><strong>${q?.title||q?.kind||id}</strong><br/><span class="meta">${ans}</span></div></div>`;
      }).join('');
    }

    function updatePathbar(){
      const el = document.getElementById('pathbar');
      if(!el) return;
      const body = renderPath();
      el.innerHTML = '<h4>Choice History</h4>' + (body || '<div class="meta">Your choice history will show up here...</div>');
    }

    function onChoose(ev){
      const btn = ev.currentTarget;
      const next = btn.getAttribute('data-next');
      const key  = btn.getAttribute('data-key');
      State.answers[State.current] = key;
      State.history.push(State.current);
      State.current = next;
      render(State.current);
    }

    function onBack(){ if(!State.history.length) return; State.current = State.history.pop(); render(State.current); }
    function onRestart(){ State.history = []; State.answers = {}; State.current = FLOW.start; render(State.current); }

    const back = document.getElementById('backBtn'); if (back) back.addEventListener('click', onBack);
    const rst = document.getElementById('restartBtn'); if (rst) rst.addEventListener('click', onRestart);

    // =====================
    // Self-tests (minimal)
    // =====================
    function runSelfTests(){
      const errors = [];
      if (!FLOW || typeof FLOW !== 'object') errors.push('FLOW is not an object.');
      if (!FLOW.start) errors.push('FLOW.start is missing.');
      if (!FLOW.nodes || typeof FLOW.nodes !== 'object') errors.push('FLOW.nodes is missing or not an object.');
      if (FLOW.start && !FLOW.nodes[FLOW.start]) errors.push(`FLOW.start '${FLOW.start}' does not exist in nodes.`);

      for (const [id, node] of Object.entries(FLOW.nodes||{})){
        if (!node.kind) errors.push(`Node '${id}' missing kind.`);
        if (!node.title) errors.push(`Node '${id}' missing title.`);
        if (node.kind === 'question'){
          if (!Array.isArray(node.choices) || node.choices.length === 0){
            errors.push(`Question node '${id}' must have non-empty choices array.`);
          } else {
            node.choices.forEach((c, idx)=>{
              if (!c || typeof c.next !== 'string') errors.push(`Choice ${idx} of '${id}' missing next.`);
              if (c && typeof c.label !== 'string') errors.push(`Choice ${idx} of '${id}' missing label.`);
              if (c && typeof c.key !== 'string') errors.push(`Choice ${idx} of '${id}' missing key.`);
              if (c && !FLOW.nodes[c.next]) errors.push(`Choice ${idx} of '${id}' points to unknown node '${c.next}'.`);
            });
          }
        } else if (node.kind === 'result'){
          if (!Array.isArray(node.items)) errors.push(`Result node '${id}' should have an items array.`);
          if (Array.isArray(node.actions)){
            node.actions.forEach((a, idx)=>{
              if (!a || typeof a.label !== 'string') errors.push(`Action ${idx} of '${id}' missing label.`);
              if (!a || typeof a.next !== 'string') errors.push(`Action ${idx} of '${id}' missing next.`);
              if (a && !FLOW.nodes[a.next]) errors.push(`Action ${idx} of '${id}' points to unknown node '${a.next}'.`);
            });
          }
          if (node.next && !FLOW.nodes[node.next]) errors.push(`Result node '${id}' next points to unknown node '${node.next}'.`);
        } else {
          errors.push(`Node '${id}' has invalid kind '${node.kind}'.`);
        }
      }

      try {
        let steps = 0; let cursor = FLOW.start;
        while (steps < 30){
          const n = FLOW.nodes[cursor];
          if (!n) { errors.push(`Traversal: missing node '${cursor}'.`); break; }
          if (n.kind === 'question'){
            const ch = n.choices[0];
            cursor = ch.next; steps++;
          } else if (n.kind === 'result'){
            if (Array.isArray(n.actions) && n.actions.length){ cursor = n.actions[0].next; steps++; }
            else if (n.next){ cursor = n.next; steps++; }
            else { break; }
          }
        }
      } catch (e){ errors.push('Traversal threw: ' + (e && e.message)); }

      return errors;
    }

    function showDiagnostics(msgs){
      const box = document.getElementById('diag');
      if (!box) return;
      if (!msgs.length){
        if (new URLSearchParams(location.search).get('debug') === '1'){
          box.classList.add('ok');
          box.textContent = 'Self-tests passed.';
          box.style.display = 'block';
        }
        return;
      }
      box.classList.remove('ok');
      box.innerHTML = '<strong>Self-test failures:</strong><br>' + msgs.map(m=>`• ${m}`).join('<br>');
      box.style.display = 'block';
    }

    // Boot
    render(State.current);
    showDiagnostics(runSelfTests());
  </script>
</body>
</html>
